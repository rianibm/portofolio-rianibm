---
import { getCollection } from "astro:content";
const allPosts = await getCollection("blog");
import FormattedDate from "@/components/FormattedDate.astro";
import { Icon } from "astro-icon/components";
import UIProjectsNDA from "@/components/UIProjectsNDA.astro";

interface Props {
  compact?: boolean;
}
const { compact = false } = Astro.props;

const bgClasses = [
  "bg-pgreen rounded-full",
  "bg-pblue rounded-2xl",
  "bg-ppink ",
  "bg-pyellow rounded-md",
];
const getBgClass = (i: number) => bgClasses[i % bgClasses.length];

const groups = [
  {
    label: "Core Products",
    slugs: ["affiliator", "web-3pl", "memberplus", "gamified-tiering", "gamified-reward"],
  },
  {
    label: "Side Projects",
    slugs: ["hire-green-jobs", "perkantas-yogyakarta"],
  },
  {
    label: "Exploratory & Personal Projects",
    slugs: ["spillr", "sky-explorer"],
  },
];

const displayGroups = compact
  ? [{ label: "Core Products", slugs: groups[0].slugs.slice(0, 3) }]
  : groups;

const postMap = new Map(allPosts.map((p) => [p.id, p]));
---
<section class="flex flex-col text-center gap-4">
  <p class="text-pblack animate-on-scroll from-bottom">Meet My</p>
  <h2 class="text-2xl md:text-4xl font-bold animate-on-scroll from-bottom" style="--delay: 0.1s">Selected Work</h2>

  {!compact && (
    <div
      id="section-label"
      class="hidden md:block sticky top-[4.5rem] z-20 bg-white/80 backdrop-blur-sm py-1.5 text-[11px] text-black/40 tracking-widest font-normal uppercase transition-opacity duration-300 opacity-0 pointer-events-none"
      aria-hidden="true"
    >
      <span id="section-label-text"></span>
    </div>
  )}

  {displayGroups.map((group, gi) => (
    <div class="py-10">
      {!compact && <h3 class="section-heading text-lg md:text-2xl font-semibold mb-6 animate-on-scroll from-bottom" data-section={group.label}>{group.label}</h3>}
      <ul class="flex flex-wrap justify-center gap-6 md:gap-8">
        {group.slugs.map((slug, i) => {
          const post = postMap.get(slug);
          if (!post) return null;
          const bgClass = getBgClass(gi * 5 + i);
          return (
            <li class="w-full max-w-sm md:w-72 text-left rounded-3xl border-1 border-black shadow-card group hover:shadow-hover transition px-4 py-6 flex flex-col gap-6 animate-on-scroll from-bottom settle" style={`--delay: ${i * 0.1}s`}>
              <a href={`/works/${post.id}/`} class="flex flex-col gap-4">
                <div
                  class={`${bgClass} text-4xl p-2 self-start border-1 border-black shadow-card1 group-hover:shadow-card transition`}
                >
                  <Icon name={post.data.icon} aria-hidden="true" />
                </div>
                <h4 class="text-xl font-semibold">{post.data.title}</h4>
                <p class="date -mt-4 text-sm font-light">
                  <FormattedDate date={post.data.pubDate} />
                </p>
              </a>
              <div class="text-sm text-gray-600 line-clamp-3 leading-relaxed" set:html={post.data.description} />
            </li>
          );
        })}
      </ul>
    </div>
  ))}

  {compact && (
    <a
      href="/works/"
      class="self-center bg-pgreen px-6 py-3 border-1 border-black rounded-lg shadow-card hover:shadow-hover transition font-medium animate-on-scroll from-bottom settle"
    >
      View All Projects
    </a>
  )}

  {!compact && <UIProjectsNDA />}
</section>